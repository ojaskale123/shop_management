<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="shop-nav">üõí Cart</div>

<div style="padding:15px; max-width:700px; margin:auto;">
  <button class="btn" style="margin-bottom:15px;" onclick="goBack()">‚Üê Back</button>

  <ul id="cartList" style="list-style:none; padding:0;"></ul>

  <div id="emptyCart" style="text-align:center; margin-top:40px; display:none;">
    <strong>Cart is empty</strong>
  </div>

  <div id="cartSummary" style="margin-top:20px; display:none;">
    <hr />
    <h3>Total Items: <span id="totalItems">0</span></h3>
    <h2>Total Amount: ‚Çπ<span id="totalAmount">0</span></h2>
    <button class="btn" style="width:100%; margin-top:10px;" onclick="checkoutCart()">
      Mark as Paid
    </button>
  </div>
</div>

<div class="bottom-nav">
  <button onclick="location.href='index.html'">üñ•Ô∏èHome</button>
  <button onclick="location.href='add.html'">‚ûï Add</button>
  <button onclick="location.href='sell.html'">üõí Sell</button>
  <button onclick="location.href='history.html'">‚åõStats</button>
</div>

<!-- üî• IMPORTANT: NO type="module" -->
<script src="script.js"></script>

<script>
function goBack() {
  window.location.href = "sell.html";
}

// ================================
// RENDER CART
// ================================
function renderCartPage() {
  const list = document.getElementById("cartList");
  const empty = document.getElementById("emptyCart");
  const summary = document.getElementById("cartSummary");

  const currentCart = JSON.parse(localStorage.getItem("cart")) || {};
  const keys = Object.keys(currentCart);

  list.innerHTML = "";

  if (keys.length === 0) {
    empty.style.display = "block";
    summary.style.display = "none";
    return;
  }

  empty.style.display = "none";
  summary.style.display = "block";

  let totalItems = 0;
  let totalAmount = 0;

  keys.forEach(barcode => {
    const data = currentCart[barcode];
    const amount = data.qty * data.price;

    totalItems += data.qty;
    totalAmount += amount;

    const li = document.createElement("li");
    li.style.background = "#232323";
    li.style.padding = "12px";
    li.style.borderRadius = "12px";
    li.style.marginBottom = "10px";

    li.innerHTML = `
      <strong>${data.name}</strong>
      <div style="display:flex; justify-content:space-between; margin-top:5px;">
        <span>‚Çπ${data.price} √ó ${data.qty} ${data.unit}</span>
        <span>‚Çπ${amount}</span>
      </div>
      <div style="display:flex; gap:6px; margin-top:8px; align-items:center;">
        <button class="qty-btn" onclick="changeCartQty('${barcode}', -1)">‚àí</button>
        <span>${data.qty}</span>
        <button class="qty-btn" onclick="changeCartQty('${barcode}', 1)">+</button>
        <button class="btn" style="background:#ff4d4d; margin-left:auto;" onclick="removeCartItem('${barcode}')">Remove</button>
      </div>
    `;
    list.appendChild(li);
  });

  document.getElementById("totalItems").innerText = totalItems;
  document.getElementById("totalAmount").innerText = totalAmount;
}

// ================================
// CART CONTROLS
// ================================
function changeCartQty(barcode, change) {
  const currentCart = JSON.parse(localStorage.getItem("cart")) || {};
  if (!currentCart[barcode]) return;

  currentCart[barcode].qty += change;
  if (currentCart[barcode].qty <= 0) delete currentCart[barcode];

  localStorage.setItem("cart", JSON.stringify(currentCart));
  renderCartPage();
  updateCartBar();
}

function removeCartItem(barcode) {
  const currentCart = JSON.parse(localStorage.getItem("cart")) || {};
  delete currentCart[barcode];
  localStorage.setItem("cart", JSON.stringify(currentCart));
  renderCartPage();
  updateCartBar();
}

// ================================
// CHECKOUT (HISTORY + STOCK FIX)
// ================================
function checkoutCart() {
  const currentCart = JSON.parse(localStorage.getItem("cart")) || {};
  if (Object.keys(currentCart).length === 0) return;

  let totalItems = 0;
  let totalAmount = 0;

  for (let barcode in currentCart) {
    const data = currentCart[barcode];
    const item = stock.find(i => i.barcode === barcode);
    if (!item) continue;

    item.quantity -= data.qty;
    totalItems += data.qty;
    totalAmount += data.qty * data.price;
  }

  history.push({
    type: "Sale",
    date: new Date().toLocaleString(),
    totalItems,
    totalAmount,
    items: currentCart
  });

  localStorage.setItem("stock", JSON.stringify(stock));
  localStorage.setItem("history", JSON.stringify(history));
  localStorage.removeItem("cart");

  renderCartPage();
  updateCartBar();
  alert("Payment marked as paid ‚úî");
}

renderCartPage();
</script>

</body>
</html>
