<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sell</title>
<link rel="stylesheet" href="style.css">

<style>
/* =================== SELL PAGE STYLES =================== */
#stockList li {
  background: #232323;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

#stockList li div {
  display: flex;
  align-items: center;
  gap: 10px;
}

.qty-btn {
  background-color: #2c2c2c;
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 20px;
  padding: 10px 15px;
  cursor: pointer;
}

.qty-btn:hover {
  background-color: #00a862;
}

#stockList strong {
  font-size: 18px;
}

#stockList small {
  color: #aaa;
}

#stockList input {
  color: #fff;
  background: #2c2c2c;
  border: none;
  border-radius: 8px;
  width: 60px;
  text-align: center;
}
</style>
</head>

<body>

<div class="shop-nav">My Shop Name</div>

<div style="padding:20px; max-width:700px; margin:auto; padding-bottom:200px;">

  <input type="text" id="searchItem" class="search-bar"
    placeholder="Search item..." onkeyup="searchStock()">

  <ul id="stockList" style="list-style:none; padding:0; margin-top:15px;"></ul>

</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <button onclick="location.href='index.html'">üñ•Ô∏èHome</button>
  <button onclick="location.href='add.html'">‚ûï Add</button>
  <button onclick="location.href='cart.html'">üõí Cart</button>
  <button onclick="location.href='history.html'">‚åõStats</button>
</div>

<!-- CART BAR -->
<div id="cartBar" style="
  position: fixed;
  bottom: 70px;
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  max-width: 700px;
  background: #00a862;
  color: #000;
  padding: 12px 16px;
  border-radius: 14px;
  display: none;
  justify-content: space-between;
  align-items: center;
  font-weight: bold;
  z-index: 1000;
">
  <span id="cartInfo">0 items | ‚Çπ0</span>
  <button onclick="goToCart()" style="
    background:#000;
    color:#00a862;
    border:none;
    padding:6px 12px;
    border-radius:8px;
    cursor:pointer;
  ">View Cart</button>
</div>

<script src="script.js"></script>

<script>
/* ================= CART LOGIC ================= */

let cartQty = {};
let interval;

function populateSell(list = stock) {
  const ul = document.getElementById("stockList");
  if (!ul) return;

  ul.innerHTML = "";

  list.filter(i => i.quantity > 0).forEach(item => {
    const step = (item.unit === "kg" || item.unit === "g") ? 0.1 : 1;
    if (cartQty[item.name] === undefined) cartQty[item.name] = 0;

    const li = document.createElement("li");
    li.innerHTML = `
      <div style="flex:1; flex-direction: column;">
        <strong>${item.name}</strong>
        <small>Available: ${item.quantity} ${item.unit}</small>
      </div>

      <div style="display:flex; align-items:center; margin-top:10px;">
        <button class="qty-btn"
          onmousedown="startChange('${item.name}', -${step})"
          onmouseup="stopChange()" onmouseleave="stopChange()">‚àí</button>

        <input id="qty-${item.name}" value="${cartQty[item.name]}"
          oninput="manualQty('${item.name}', ${item.quantity})">

        <button class="qty-btn"
          onmousedown="startChange('${item.name}', ${step})"
          onmouseup="stopChange()" onmouseleave="stopChange()">+</button>
      </div>

      <button class="btn" style="margin-top:10px;"
        onclick="addToCart('${item.name}')">Add to Cart</button>
    `;
    ul.appendChild(li);
  });
}

function startChange(name, change) {
  updateQty(name, change);
  interval = setInterval(() => updateQty(name, change), 200);
}

function stopChange() {
  clearInterval(interval);
}

function updateQty(name, change) {
  const item = stock.find(i => i.name === name);
  if (!item) return;

  let next = (cartQty[name] || 0) + change;
  next = (item.unit === "kg" || item.unit === "g")
    ? Math.round(next * 10) / 10
    : Math.round(next);

  if (next < 0) next = 0;
  if (next > item.quantity) next = item.quantity;

  cartQty[name] = next;
  document.getElementById(`qty-${name}`).value = next;
}

function manualQty(name, max) {
  let val = parseFloat(document.getElementById(`qty-${name}`).value);
  if (isNaN(val) || val < 0) val = 0;
  if (val > max) val = max;
  cartQty[name] = val;
}

function addToCart(name) {
  const qty = cartQty[name];
  if (!qty) return;

  let cart = JSON.parse(localStorage.getItem("cart")) || {};
  cart[name] = (cart[name] || 0) + qty;
  localStorage.setItem("cart", JSON.stringify(cart));

  cartQty[name] = 0;
  document.getElementById(`qty-${name}`).value = 0;

  updateCartBar();
}

function updateCartBar() {
  let cart = JSON.parse(localStorage.getItem("cart")) || {};
  let totalItems = 0;
  let totalAmount = 0;

  for (let name in cart) {
    const item = stock.find(i => i.name === name);
    if (item) {
      totalItems += cart[name];
      totalAmount += cart[name] * (item.price || 0);
    }
  }

  const bar = document.getElementById("cartBar");
  const info = document.getElementById("cartInfo");

  if (totalItems > 0) {
    info.innerText = `${totalItems} items | ‚Çπ${totalAmount}`;
    bar.style.display = "flex";
  } else {
    bar.style.display = "none";
  }
}

function goToCart() {
  location.href = "cart.html";
}

populateSell();
updateCartBar();
</script>

<script type="module">
import { auth } from "./firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

onAuthStateChanged(auth, (user) => {
  if (!user) window.location.href = "login.html";
});
</script>

</body>
</html>
