<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sell Stock</title>
<link rel="stylesheet" href="style.css">
<style>
/* =================== SELL PAGE SPECIFIC STYLES =================== */
#stockList li {
  background: #232323;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

#stockList li div {
  display: flex;
  align-items: center;
  gap: 10px;
}

.qty-btn {
  background-color: #2c2c2c;
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 20px;
  padding: 10px 15px;
  cursor: pointer;
  transition: 0.2s;
  user-select: none;
}

.qty-btn:hover {
  background-color: #00a862;
}

#stockList strong {
  font-size: 18px;
}

#stockList small {
  color: #aaa;
}
</style>
</head>
<body>

<div class="shop-nav">My Shop Name</div>

<div style="padding:20px; max-width:700px; margin:auto; padding-bottom:150px;">

  <!-- SEARCH -->
  <input type="text" id="searchItem" class="search-bar" placeholder="Search item..." onkeyup="searchStock()">

  <!-- STOCK LIST -->
  <ul id="stockList" style="list-style:none; padding:0; margin-top:15px;"></ul>

</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <button onclick="location.href='index.html'">Dashboard</button>
  <button onclick="location.href='add.html'">Add</button>
  <button onclick="location.href='sell.html'">Sell</button>
  <button onclick="location.href='history.html'">History</button>
</div>

<script src="script.js"></script>
<script>
// ==================== SELL PAGE JS ====================

// TEMP QUANTITIES FOR SELLING
let sellQty = {}; 

// POPULATE STOCK LIST
function populateSell(list = stock) {
  const ul = document.getElementById("stockList");
  if (!ul) return;

  ul.innerHTML = "";

  // Show only items with quantity > 0
  const filtered = list.filter(item => item.quantity > 0);

  filtered.forEach((item, index) => {
    if (sellQty[item.name] === undefined) sellQty[item.name] = 0;

    const li = document.createElement("li");
    li.innerHTML = `
      <div style="flex:1; flex-direction: column;">
        <strong>${item.name}</strong>
        <small>Available: ${item.quantity} ${item.unit}</small>
      </div>
      <div style="display:flex; align-items:center; margin-top:10px;">
        <button class="qty-btn" onmousedown="startChange('${item.name}', -1)" onmouseup="stopChange()" ontouchstart="startChange('${item.name}', -1)" ontouchend="stopChange()">âˆ’</button>
        <span id="sellQty-${item.name}" style="margin:0 10px;">${sellQty[item.name]}</span>
        <button class="qty-btn" onmousedown="startChange('${item.name}', 1)" onmouseup="stopChange()" ontouchstart="startChange('${item.name}', 1)" ontouchend="stopChange()">+</button>
      </div>
      <button class="btn" style="margin-top:10px;" onclick="confirmSell('${item.name}')">Confirm Sell</button>
    `;
    ul.appendChild(li);
  });
}

// SEARCH FUNCTION
function searchStock() {
  const input = document.getElementById("searchItem").value.toLowerCase();
  const filtered = stock.filter(item => item.quantity > 0 && item.name.toLowerCase().includes(input));
  populateSell(filtered);
}

// CHANGE QUANTITY WITH LONG PRESS
let interval;
function startChange(name, change) {
  updateQty(name, change);
  interval = setInterval(() => updateQty(name, change), 200); // hold increase/decrease every 200ms
}

function stopChange() {
  clearInterval(interval);
}

function updateQty(name, change) {
  const item = stock.find(i => i.name === name);
  if (!item) return;

  let next = (sellQty[name] || 0) + change;
  if (next < 0) next = 0;
  if (next > item.quantity) next = item.quantity;

  sellQty[name] = next;
  document.getElementById(`sellQty-${name}`).textContent = next;
}

// CONFIRM SELL
function confirmSell(name) {
  const qty = sellQty[name];
  if (!qty || qty <= 0) return alert("Select quantity to sell");

  const item = stock.find(i => i.name === name);
  if (!item) return;

  item.quantity -= qty;

  history.push({
    date: new Date().toLocaleString(),
    product: item.name,
    quantity: qty,
    unit: item.unit,
    type: "Sell"
  });

  sellQty[name] = 0;
  saveData();
  alert(`Sold ${qty} of ${item.name}`);

  populateSell();
  updateDashboard();
  populateHistory();
}

// INITIAL POPULATION
populateSell();
</script>

</body>
</html>
