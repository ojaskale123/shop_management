<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sell Stock</title>
<link rel="stylesheet" href="style.css">
<style>
/* =================== SELL PAGE SPECIFIC STYLES =================== */
#stockList li {
  background: #232323;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

#stockList li div {
  display: flex;
  align-items: center;
  gap: 10px;
}

.qty-btn {
  background-color: #2c2c2c;
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 20px;
  padding: 10px 15px;
  cursor: pointer;
  transition: 0.2s;
  user-select: none;
}

.qty-btn:hover {
  background-color: #00a862;
}

#stockList strong {
  font-size: 18px;
}

#stockList small {
  color: #aaa;
}

#stockList input {
  color: #fff;
  background: #2c2c2c;
  border: none;
  border-radius: 8px;
  width: 50px;
  text-align: center;
}
</style>
</head>
<body>

<div class="shop-nav">My Shop Name</div>

<div style="padding:20px; max-width:700px; margin:auto; padding-bottom:150px;">

  <!-- SEARCH -->
  <input type="text" id="searchItem" class="search-bar" placeholder="Search item..." onkeyup="searchStock()">

  <!-- STOCK LIST -->
  <ul id="stockList" style="list-style:none; padding:0; margin-top:15px;"></ul>

</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <button onclick="location.href='index.html'">üñ•Ô∏èHome</button>
  <button onclick="location.href='add.html'">‚ûï Add</button>
  <button onclick="location.href='sell.html'">üõí Sell</button>
  <button onclick="location.href='history.html'">‚åõStats</button>
</div>

<script src="script.js"></script>
<script>
// ==================== SELL PAGE FIXES ====================

// TEMP QUANTITIES FOR SELLING
let interval; 
let currentChange = null;

// POPULATE SELL LIST FIX
function populateSell(list = stock) {
  const ul = document.getElementById("stockList");
  if (!ul) return;

  ul.innerHTML = "";

  const filtered = list.filter(item => item.quantity > 0);

  filtered.forEach(item => {
    if (sellQty[item.name] === undefined) sellQty[item.name] = 0;

    // Step based on unit
    const step = (item.unit === "kg" || item.unit === "g") ? 0.1 : 1;

    const li = document.createElement("li");
    li.innerHTML = `
      <div style="flex:1; flex-direction: column;">
        <strong>${item.name}</strong>
        <small>Available: ${item.quantity} ${item.unit}</small>
      </div>
      <div style="display:flex; align-items:center; margin-top:10px;">
        <button class="qty-btn" 
          onmousedown="startChange('${item.name}', -${step})" 
          onmouseup="stopChange()" 
          onmouseleave="stopChange()" 
          ontouchstart="startChange('${item.name}', -${step})" 
          ontouchend="stopChange()">‚àí</button>
        <input id="sellQty-${item.name}" value="${sellQty[item.name]}" 
          oninput="manualQty('${item.name}', ${item.quantity}, ${step})">
        <button class="qty-btn" 
          onmousedown="startChange('${item.name}', ${step})" 
          onmouseup="stopChange()" 
          onmouseleave="stopChange()" 
          ontouchstart="startChange('${item.name}', ${step})" 
          ontouchend="stopChange()">+</button>
      </div>
      <button class="btn" style="margin-top:10px;" onclick="confirmSell('${item.name}')">Confirm Sell</button>
    `;
    ul.appendChild(li);
  });
}

// FIXED FUNCTIONS
function startChange(name, change) {
  currentChange = {name, change};
  updateQty(name, change); // single click fix
  interval = setInterval(() => updateQty(name, change), 200);
}

function stopChange() {
  clearInterval(interval);
  currentChange = null;
}

function updateQty(name, change) {
  const item = stock.find(i => i.name === name);
  if (!item) return;

  let next = (sellQty[name] || 0) + change;

  if (item.unit === "kg" || item.unit === "g") {
    next = Math.round(next * 10) / 10;
  } else {
    next = Math.round(next);
  }

  if (next < 0) next = 0;
  if (next > item.quantity) next = item.quantity;

  sellQty[name] = next;
  const el = document.getElementById(`sellQty-${name}`);
  if (el) el.value = next;
}

// MANUAL INPUT
function manualQty(name, max, step) {
  let val = parseFloat(document.getElementById(`sellQty-${name}`).value);
  if (isNaN(val)) val = 0;

  const item = stock.find(i => i.name === name);
  if (!item) return;

  if (item.unit === "kg" || item.unit === "g") {
    val = Math.round(val * 10) / 10;
  } else {
    val = Math.round(val);
  }

  if (val < 0) val = 0;
  if (val > item.quantity) val = item.quantity;

  sellQty[name] = val;
  document.getElementById(`sellQty-${name}`).value = val;
}

// INITIAL POPULATION
populateSell();
</script>

</body>
</html>
